#!/bin/sh

usage()
{
    echo "usage: import container[.squashfs] [name]"
    exit 1
}

if [ $# -lt 1 ]; then
    usage
fi

path=$1
file=`basename $1`

if [ $# -eq 2 ]; then
    nm=$2
else
    nm=${file%.*}
fi

if [ ! -e $path -o -z $nm ]; then
    usage
fi

dir=/var/lib/lxc/$nm
if [ -e $dir/config ]; then
   echo "Container $nm already exists, delete it first."
   exit 1
fi

mkdir -p $dir/rootfs

cat > $dir/config << EOF
lxc.uts.name = $nm
lxc.rootfs.path = $path
lxc.rootfs.mount = $dir/rootfs
lxc.rootfs.options = -t squashfs
lxc.mount.auto = cgroup:mixed proc:mixed sys:mixed
lxc.mount.entry=run run tmpfs rw,nodev,relatime,mode=755 0 0
lxc.mount.entry=shm dev/shm tmpfs rw,nodev,noexec,nosuid,relatime,mode=1777,create=dir 0 0
lxc.tty.max = 4
lxc.pty.max=1024
EOF

